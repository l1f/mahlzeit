# Development

In order to work on *Mahlzeit*, several tools are required:

- Go 1.20 compiler or newer (since the application is written in Go)
- [sqlc](https://sqlc.dev) for code-generation of SQL queries
- [dbmate](https://github.com/amacneil/dbmate) for our migrations.

Optional, but recommended:

- `docker compose` for quickly spinning up  development databases
- [direnv](https://direnv.net/)

---

The files in the repository are prepared for the development with `docker compose`. In order to start the application,
we need to create the database and after that we're ready to go!

```shell
$ docker compose up -d  # creating the database container
$ dbmate --wait up      # applying the migrations
$ go run ./cmd/mahlzeit # starting the application
```

Now *Mahlzeit* is starting and reachable on [localhost:4000](http://localhost:4000/)! 

## Working with the database

### Creating the test database

Once `dbmate` is installed, you can spin up an empty database with `dbmate up`. As of today, there's no seed data
available, but we aim to provide it in the future.

### Adding a new migration

`dbmate` is also used for creating new migrations. Assuming we want to create a migration for adding a new table, e.g.
for recipe utensils, we might do it the following way:

1. Create a new migration with a descriptive name. `dbmate new add-utensils-table`
2. Open the new migration file: `editor db/migrations/*-add-utensils-table.sql`
3. Fill the file with the following content:

   ```sql
   -- migrate:up
   create table utensils
   (
       id   bigint primary key generated by default as identity,
       name text not null
   );
   
   -- migrate:down
   drop table utensils;
   ```
4. Apply the new migration by running `dbmate up`. The `schema.sql` should be updated automatically afterwards.
5. Done!

### Recommendations for new migrations

1. Use `bigint` for the identifier.
   Although we might never reach the limit of 4-byte length integers, it's better to be prepared.
2. Use `not null` where possible. Working with nullables or `nil` in Go can be a pain, so try to avoid nullable values.
   It's recommended to set it to `not null` with a default value.
3. Use lowercase SQL. It's just a preference, but it's consistent with the rest of the project.
